# -----------------------------------------------------------------------------
# Optional: PgBouncer in front of Postgres. Use when running multiple API/worker
# replicas to avoid exhausting Postgres max_connections.
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.pgbouncer.yml up -d
#
# Then set API DATABASE_URL to postgres://postgres:postgres@pgbouncer:5432/postgres
# (or use env in api service below). See docs/PGBOUNCER.md.
# -----------------------------------------------------------------------------

services:
  pgbouncer:
    image: edoburu/pgbouncer:1.21.0
    container_name: citewalk-pgbouncer
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-postgres}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 25
    ports:
      - "127.0.0.1:6432:5432"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "127.0.0.1", "-p", "5432"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  api:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@pgbouncer:5432/${POSTGRES_DB:-postgres}
    depends_on:
      pgbouncer:
        condition: service_healthy
